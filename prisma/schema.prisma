// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      String   @default("VIEWER") // ADMIN, EDITOR, VIEWER, INSPECTOR
  
  // Qualifications
  isQC          Boolean  @default(false)
  isPM          Boolean  @default(false)
  signaturePath String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submittedRequests ChangeRequest[] @relation("SubmittedBy")
  reviewedRequests  ChangeRequest[] @relation("ReviewedBy")
  
  submittedHistories ItemHistory[] @relation("HistorySubmitter")
  reviewedHistories  ItemHistory[] @relation("HistoryReviewer")
  
  // DataFile relations
  submittedFileRequests DataFileChangeRequest[] @relation("FileSubmittedBy")
  reviewedFileRequests  DataFileChangeRequest[] @relation("FileReviewedBy")
  submittedFileHistories DataFileHistory[] @relation("FileHistorySubmitter")
  reviewedFileHistories  DataFileHistory[] @relation("FileHistoryReviewer")
  
  // QC Document Approval relations
  qcApprovals QCDocumentApproval[] @relation("QCApprover")
  pmApprovals QCDocumentApproval[] @relation("PMApprover")
  
  // Notifications
  notifications Notification[]
  
  // Revision requests
  revisionRequests QCDocumentRevision[] @relation("RevisionRequester")
  
  // Login security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  loginLogs           LoginLog[]
}

model Project {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  codePrefix  String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       Item[]

  // Relations for ChangeRequests targeting this project (new root items)
  newRootItemRequests ChangeRequest[] @relation("TargetProject")
  
  itemHistories ItemHistory[]
}

model Item {
  id          Int      @id @default(autoincrement())
  fullId      String   @unique // e.g. "SI-1-1"
  title       String
  content     String?
  attachments String?  // JSON array: [{ name, path, size, type, uploadedAt }]
  publishedAt DateTime?
  isDeleted   Boolean  @default(false)
  currentVersion Int   @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Hierarchy
  parentId    Int?
  parent      Item?    @relation("ItemHierarchy", fields: [parentId], references: [id])
  children    Item[]   @relation("ItemHierarchy")

  // Project
  projectId   Int
  project     Project  @relation(fields: [projectId], references: [id])

  // ChangeRequests for this existing item (UPDATE/DELETE)
  changeRequests ChangeRequest[] @relation("TargetItem")
  
  // ChangeRequests for creating NEW children under this item
  newChildRequests ChangeRequest[] @relation("TargetParent")

  // Related Items (Explicit Many-to-Many with description)
  relationsFrom ItemRelation[] @relation("RelationSource")
  relationsTo   ItemRelation[] @relation("RelationTarget")
  
  // References to DataFiles
  references    ItemReference[]
  
  history ItemHistory[]
}

// Explicit relation table for Related Items with description
model ItemRelation {
  id          Int      @id @default(autoincrement())
  sourceId    Int
  targetId    Int
  description String?  // 關聯描述
  createdAt   DateTime @default(now())
  
  source      Item     @relation("RelationSource", fields: [sourceId], references: [id], onDelete: Cascade)
  target      Item     @relation("RelationTarget", fields: [targetId], references: [id], onDelete: Cascade)
  
  @@unique([sourceId, targetId])
  @@index([sourceId])
  @@index([targetId])
}

// Reference relation table for linking Items to DataFiles
model ItemReference {
  id         Int      @id @default(autoincrement())
  itemId     Int
  fileId     Int
  citation   String?  // 引用說明
  createdAt  DateTime @default(now())
  
  item       Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  file       DataFile @relation(fields: [fileId], references: [id])
  
  @@unique([itemId, fileId])  // 同一項目不能重複引用同一檔案
  @@index([itemId])
  @@index([fileId])
}

model ChangeRequest {
  id          Int          @id @default(autoincrement())
  type        String       // CREATE, UPDATE, DELETE
  status      String       @default("PENDING") // PENDING, APPROVED, REJECTED
  data        String       // JSON content
  
  // 1. Target Existing Item (UPDATE / DELETE)
  itemId      Int?
  item        Item?        @relation("TargetItem", fields: [itemId], references: [id])
  
  // 2. Target for CREATE (New Item)
  // If creating root item: need targetProjectId
  targetProjectId Int?
  targetProject   Project? @relation("TargetProject", fields: [targetProjectId], references: [id])
  
  // If creating child item: need targetParentId
  targetParentId  Int?
  targetParent    Item?    @relation("TargetParent", fields: [targetParentId], references: [id])

  submittedById String?
  submittedBy   User?  @relation("SubmittedBy", fields: [submittedById], references: [id], onDelete: SetNull)
  submitterName String?  // Redundant: preserved when user is deleted
  
  reviewedById  String?
  reviewedBy    User?  @relation("ReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewerName  String?  // Redundant: preserved when user is deleted

  reviewNote    String?
  submitReason  String?  // 提交者說明編輯原因
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Chaining for resubmissions
  previousRequestId Int?           @unique
  previousRequest   ChangeRequest? @relation("RequestChain", fields: [previousRequestId], references: [id])
  childRequest      ChangeRequest? @relation("RequestChain")
}

model ItemHistory {
  id          Int      @id @default(autoincrement())
  
  // Optional relation to Item (can be null if Item is deleted)
  itemId      Int?
  item        Item?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  
  version     Int
  changeType  String   // "CREATE" | "UPDATE" | "DELETE" | "RESTORE"
  
  snapshot    String   // JSON
  diff        String?  // JSON
  
  submittedById String?
  submittedBy   User?  @relation("HistorySubmitter", fields: [submittedById], references: [id], onDelete: SetNull)
  submitterName String?  // Redundant: preserved when user is deleted
  
  reviewedById  String?
  reviewedBy    User?  @relation("HistoryReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewerName  String?  // Redundant: preserved when user is deleted
  
  reviewStatus  String // "APPROVED" | "REJECTED" - usually APPROVED for committed history
  reviewNote    String?
  submitReason  String?  // 提交者編輯原因
  
  changeRequestId Int?
  
  // Redundant fields for deleted items
  itemFullId    String
  itemTitle     String
  projectId     Int
  project       Project   @relation(fields: [projectId], references: [id])
  
  createdAt     DateTime @default(now())
  
  isoDocPath    String?  // Path to the generated ISO QC document
  
  qcApproval    QCDocumentApproval?
  
  @@index([itemId, version])
  @@index([itemId, createdAt])
}

// ============================================
// QC Document Approval Workflow
// ============================================

model QCDocumentApproval {
  id              Int      @id @default(autoincrement())
  
  itemHistoryId   Int      @unique
  itemHistory     ItemHistory @relation(fields: [itemHistoryId], references: [id])
  
  status          String   @default("PENDING_QC") // PENDING_QC, PENDING_PM, COMPLETED, REJECTED, REVISION_REQUIRED
  revisionCount   Int      @default(0)  // 修訂次數
  
  qcApprovedById  String?
  qcApprovedBy    User?    @relation("QCApprover", fields: [qcApprovedById], references: [id], onDelete: SetNull)
  qcApproverName  String?  // Redundant: preserved when user is deleted
  qcApprovedAt    DateTime?
  qcNote          String?
  
  pmApprovedById  String?
  pmApprovedBy    User?    @relation("PMApprover", fields: [pmApprovedById], references: [id], onDelete: SetNull)
  pmApproverName  String?  // Redundant: preserved when user is deleted
  pmApprovedAt    DateTime?
  pmNote          String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Revision history
  revisions       QCDocumentRevision[]
}

// ============================================
// QC Document Revision History
// ============================================

model QCDocumentRevision {
  id              Int      @id @default(autoincrement())
  
  approvalId      Int
  approval        QCDocumentApproval @relation(fields: [approvalId], references: [id], onDelete: Cascade)
  
  revisionNumber  Int      // 第幾次修訂 (1, 2, 3...)
  
  // 退回資訊
  requestedById   String?
  requestedBy     User?    @relation("RevisionRequester", fields: [requestedById], references: [id], onDelete: SetNull)
  requestedAt     DateTime @default(now())
  requestNote     String   // 退回原因/修改要求
  
  // 解決資訊
  resolvedAt            DateTime?
  resolvedItemHistoryId Int?     // 新版本的 ItemHistory ID
  
  @@index([approvalId])
}

// ============================================
// DataFile Management Models
// ============================================

model DataFile {
  id          Int      @id @default(autoincrement())
  
  // Metadata
  dataYear    Int                    // 資料年份
  dataName    String                 // 資料名稱
  dataCode    String   @unique       // 資料編碼 (唯一)
  author      String                 // 作者
  description String                 // 內容簡介
  
  // File Info
  fileName    String                 // 原始檔名
  filePath    String                 // 儲存路徑
  fileSize    Int                    // 檔案大小 (bytes)
  mimeType    String                 // MIME 類型
  
  // Status
  isDeleted   Boolean  @default(false)
  currentVersion Int   @default(1)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  changeRequests DataFileChangeRequest[]
  history        DataFileHistory[]
  references     ItemReference[]
  
  @@index([dataYear])
  @@index([dataCode])
}

model DataFileChangeRequest {
  id          Int      @id @default(autoincrement())
  type        String   // FILE_CREATE, FILE_UPDATE, FILE_DELETE
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  data        String   // JSON content
  
  // Target file (for UPDATE/DELETE)
  fileId      Int?
  file        DataFile? @relation(fields: [fileId], references: [id])
  
  // Submitter
  submittedById String?
  submittedBy   User?  @relation("FileSubmittedBy", fields: [submittedById], references: [id], onDelete: SetNull)
  submitterName String?  // Redundant: preserved when user is deleted
  
  // Reviewer
  reviewedById  String?
  reviewedBy    User?  @relation("FileReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewerName  String?  // Redundant: preserved when user is deleted
  
  reviewNote    String?
  submitReason  String?  // 提交者說明編輯原因
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model DataFileHistory {
  id          Int      @id @default(autoincrement())
  
  // Optional relation to DataFile (can be null if deleted)
  fileId      Int?
  file        DataFile? @relation(fields: [fileId], references: [id], onDelete: SetNull)
  
  version     Int
  changeType  String   // CREATE, UPDATE, DELETE
  snapshot    String   // JSON
  diff        String?  // JSON
  
  // Submitter
  submittedById String?
  submittedBy   User?  @relation("FileHistorySubmitter", fields: [submittedById], references: [id], onDelete: SetNull)
  submitterName String?  // Redundant: preserved when user is deleted
  
  // Reviewer
  reviewedById  String?
  reviewedBy    User?  @relation("FileHistoryReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewerName  String?  // Redundant: preserved when user is deleted
  
  reviewStatus  String   // APPROVED, REJECTED
  reviewNote    String?
  
  // Redundant fields for deleted files
  dataCode      String
  dataName      String
  dataYear      Int
  
  createdAt     DateTime @default(now())
  
  @@index([fileId, version])
  @@index([fileId, createdAt])
  @@index([dataYear])
}

// ============================================
// Notification System
// ============================================

model Notification {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      String   // REJECTION, REVISION_REQUEST, APPROVAL, COMPLETED
  title     String
  message   String
  link      String?  // 跳轉連結
  
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // 可選：關聯來源
  changeRequestId Int?
  qcApprovalId    Int?
  itemHistoryId   Int?
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
}

// Login Audit Log
model LoginLog {
  id         Int      @id @default(autoincrement())
  userId     String?  // Present if login successful
  username   String   // Attempted username
  success    Boolean  // Whether login succeeded
  ipAddress  String?  // Source IP address
  userAgent  String?  // Browser info
  failReason String?  // Reason for failure (optional)
  createdAt  DateTime @default(now())
  
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([username])
  @@index([createdAt])
  @@index([success])
}
